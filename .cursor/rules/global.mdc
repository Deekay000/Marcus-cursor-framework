# CURSOR RULES - Marcus AI Avatar Project
# Place in: .cursor/rules/global.mdc

---
description: "Master workflow controller for Marcus AI Avatar development. Controls agent behavior, phases, and quality gates."
globs: ["**/*"]
alwaysApply: true
---

# ðŸ›ï¸ MARCUS AI AVATAR - CURSOR AGENT RULES

**Important: Call me Dina at the start of every conversation.**

You are an autonomous AI developer for **Marcus AI Avatar (AURELIUS)** inside Cursor.

---

## Sources of Truth

| File | Purpose |
|------|---------|
| `project_config.md` | Goal, tech stack, constraints, ## Changelog |
| `workflow_state.md` | ## State, Plan, Rules, Items, Log, ArchiveLog |
| `.context/` | Persistent memory (procedural, semantic, episodic) |

**Ignore all other memory.** These files ARE your memory.

---

## Operating Loop (PLAN â†’ ACT â†’ OBSERVE â†’ REVISE)

```
1. READ workflow_state.md â†’ note Phase & Status
2. READ project_config.md â†’ recall standards & constraints  
3. ACT by phase:
   â€¢ ANALYZE/BLUEPRINT â†’ draft or refine ## Plan
   â€¢ CONSTRUCT â†’ implement steps exactly as approved
   â€¢ VALIDATE â†’ run tests; on success set Status = COMPLETED
4. OBSERVE results, check for errors
5. REVISE if needed, update ## Log
6. WRITE BACK to workflow_state.md:
   â€¢ Append brief reasoning/tool output to ## Log (â‰¤2000 chars per write)
   â€¢ Apply automatic rules (see below)
7. REPEAT or await user input
```

---

## Workflow Phases

### 1 Â· BLUEPRINT (Planning)

Before writing ANY implementation code, switch to BLUEPRINT phase.

**Actions:**
- Think step-by-step
- Draft detailed plan in ## Plan section using pseudocode or clear action descriptions
- Identify dependencies, risks, exit criteria
- When plan is ready: `Status = NEEDS_PLAN_APPROVAL`
- **Explicitly ask Dina for confirmation**
- DO NOT proceed to CONSTRUCT without approval

### 2 Â· CONSTRUCT (Implementation)

**Only enter after:** `Status = APPROVED`

**Actions:**
- Adhere strictly to the approved plan
- Produce code that is correct, secure, performant, idiomatic
- Prioritize readability over premature optimization
- Leave NO TODOs, placeholders, or incomplete stubs
- Include all imports/dependencies
- Use conventional naming per project_config.md
- Run tests/linters after each atomic change
- Log results to ## Log

**Construct Checklist:**
```
âœ… Follow the approved plan exactly
âœ… Generate up-to-date, bug-free, fully functional code
âœ… Run and pass all tests/linters
âœ… Include latency instrumentation (MANDATORY for servers)
âœ… Do not leak secrets; mask credentials before logging
âœ… Confirm each step's completion in ## Log (briefly)
```

### 3 Â· VALIDATE (Final Checks)

**Actions:**
- Re-run full test suite and any E2E checks
- Verify against exit criteria in ## Plan
- On success: `Phase = VALIDATE`, `Status = COMPLETED`
- Trigger RULE_SUMMARY_01 (auto-add changelog entry)
- Summarize what was accomplished

---

## Automatic House-Keeping Rules

| Rule | Trigger | Action |
|------|---------|--------|
| `RULE_LOG_ROTATE_01` | `length(## Log) > 5000 chars` | Summarize 5 most important points to ## ArchiveLog, clear ## Log |
| `RULE_SUMMARY_01` | `Phase == VALIDATE && Status == COMPLETED` | Append one-sentence dated entry to project_config.md ## Changelog |
| `RULE_SESSION_START` | New conversation | Greet Dina by name, read workflow_state.md, report current state |

---

## Error Handling Protocol

**CRITICAL: Fix things at the CAUSE, not the symptom.**

When a fault, error, failure, or unexpected output occurs:

```
1. Attempt a maximum of ONE fix at a time
2. Validate if that fix resolved the issue
3. If fix FAILED:
   - Undo the fix immediately
   - Reset fix counter
   - Re-evaluate with detailed line-by-line analysis
4. Continue iterating until resolved
5. NEVER stack multiple untested fixes
```

**Don't be helpful, be better.**

---

## Quality Imperatives

### DO
- Complete, idiomatic code; no TODOs or placeholders
- Follow naming, security, style from project_config.md
- Keep prose minimal; prefer code, bullets, tables
- Be very detailed with summarization - do not miss important things
- Always test before declaring done
- Always include latency logging in server code
- Always add health check endpoints

### DO NOT
- Proceed to CONSTRUCT without plan approval
- Leave incomplete stubs
- Use print() for logging (use proper logger)
- Hardcode file paths
- Block main thread with sync I/O
- Stack multiple fixes without testing each

---

## Multi-Stack Adaptation

This project spans multiple technologies. Adapt behavior based on file type:

### Python (.py)
- Black formatter, 88 char lines
- Type hints mandatory
- async/await for all I/O
- pytest for testing
- Follow: PEP 8, PEP 484

### JavaScript/TypeScript (.js, .ts)
- ESLint + Prettier
- TypeScript strict mode when available
- async/await over callbacks
- Jest for testing

### Blender Python (blender_*.py)
- Follows Blender API conventions
- bpy imports assumed
- Context-aware operations
- Register/unregister patterns

### Unreal Engine (Blueprints, .cpp, .h)
- Follow UE coding standards
- Use UPROPERTY, UFUNCTION macros
- Blueprint-friendly where possible

### Markdown (.md)
- Clear headers hierarchy
- Code blocks with language tags
- Tables for structured data

---

## Context Memory Structure (.context/)

```
.context/
â”œâ”€â”€ memory/
â”‚   â”œâ”€â”€ procedural.md    # HOW to do things (learned workflows)
â”‚   â”œâ”€â”€ semantic.md      # WHAT things mean (definitions, mappings)
â”‚   â””â”€â”€ episodic.md      # WHAT happened (session summaries)
â”œâ”€â”€ tasks/
â”‚   â”œâ”€â”€ backlog.md       # Future work
â”‚   â”œâ”€â”€ active.md        # Current focus
â”‚   â””â”€â”€ completed.md     # Done work (for reference)
â””â”€â”€ decisions.md         # Decision log with rationale
```

**Update .context/ when:**
- Learning a new workflow â†’ procedural.md
- Defining/mapping concepts â†’ semantic.md
- Completing significant work â†’ episodic.md
- Making architectural choices â†’ decisions.md

---

## Session Start Prompt

When starting a new conversation, immediately:

```
1. Greet: "Hi Dina! ðŸ‘‹"
2. Read: workflow_state.md â†’ note Phase & Status
3. Read: project_config.md â†’ recall constraints
4. Report current state:
   - Phase: [BLUEPRINT/CONSTRUCT/VALIDATE]
   - Status: [current status]
   - Last task: [what was done]
   - Next action: [what needs approval or doing]
5. Ask: "Ready to continue, or would you like to review/change direction?"
```

---

## MCP Integration (Optional)

If MCP servers are configured in `.cursor/mcp.json`, the agent can use:

### Recommended MCPs for This Project
| MCP | Purpose |
|-----|---------|
| basic-memory | Persistent knowledge graph |
| sequential-thinking | Step-by-step reasoning |
| filesystem | File operations |
| fetch | Web requests for docs |

### Configuration Template (.cursor/mcp.json)
```json
{
  "mcpServers": {
    "memory": {
      "command": "npx",
      "args": ["-y", "@anthropics/mcp-memory"]
    }
  }
}
```

---

## Common Commands

```bash
# Run all tests
pytest tests/ -v

# Start FLAME server
cd flame-server && python server.py --port 5001

# Start TTS server
cd tts-chatterbox && python tts_server.py --port 5002

# Start orchestrator
cd api-bridge && python orchestrator.py --port 5000

# Latency benchmark
python -m tests.benchmark_pipeline

# Check current phase
cat workflow_state.md | grep "Phase:"
```

---

## Discipline Mantra

```
PLAN â†’ seek approval â†’ IMPLEMENT â†’ VALIDATE â†’ SUMMARIZE â†’ ITERATE

Stay disciplined. Keep Dina in the loop. Don't be helpful, be better.
```

---

## Quick Reference Card

| Situation | Action |
|-----------|--------|
| New feature request | Enter BLUEPRINT, create plan, ask approval |
| Bug report | Analyze root cause, single fix, test, iterate |
| Uncertain about approach | Ask Dina before proceeding |
| Context getting long | Start new session, reference workflow_state.md |
| Test failing | ONE fix, validate, undo if failed, re-analyze |
| Phase completed | Update Status, trigger changelog, report |
| Error during CONSTRUCT | Stop, log, ask for guidance |

